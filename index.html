<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MediaIndex</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:      #0f0f13;
    --surface: #1a1a22;
    --border:  #2a2a36;
    --accent:  #7c6af7;
    --text:    #e8e8f0;
    --muted:   #6b6b80;
    --tag-bg:  #22222e;
    --radius:  8px;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', system-ui, sans-serif;
    font-size: 14px;
    min-height: 100vh;
  }

  /* ── Header ─────────────────────────────────────────────────────────────── */
  header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--bg);
    z-index: 100;
  }

  .logo {
    font-weight: 600;
    font-size: 16px;
    color: var(--text);
    text-decoration: none;
    flex-shrink: 0;
  }
  .logo span { color: var(--accent); }

  .search-wrap {
    flex: 1;
    max-width: 520px;
    position: relative;
  }
  .search-wrap svg {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    pointer-events: none;
  }
  #search {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: inherit;
    font-size: 14px;
    padding: 9px 12px 9px 38px;
    outline: none;
    transition: border-color .15s;
  }
  #search:focus { border-color: var(--accent); }
  #search::placeholder { color: var(--muted); }

  .header-stats {
    margin-left: auto;
    color: var(--muted);
    font-size: 12px;
    flex-shrink: 0;
    white-space: nowrap;
  }

  /* ── Filters ─────────────────────────────────────────────────────────────── */
  .filters {
    display: flex;
    gap: 8px;
    padding: 12px 24px;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
    align-items: center;
  }

  .filter-label { color: var(--muted); font-size: 12px; margin-right: 4px; }

  .pill {
    background: var(--tag-bg);
    border: 1px solid var(--border);
    border-radius: 20px;
    color: var(--muted);
    cursor: pointer;
    font-family: inherit;
    font-size: 12px;
    padding: 4px 12px;
    transition: all .15s;
  }
  .pill:hover   { border-color: var(--accent); color: var(--text); }
  .pill.active  { background: var(--accent); border-color: var(--accent); color: #fff; }

  .sort-select {
    background: var(--tag-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: inherit;
    font-size: 12px;
    padding: 4px 10px;
    outline: none;
    cursor: pointer;
    margin-left: auto;
  }
  .sort-select:focus { border-color: var(--accent); }

  /* ── Table ───────────────────────────────────────────────────────────────── */
  .table-wrap {
    overflow-x: auto;
    padding: 0 24px 40px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }

  th {
    color: var(--muted);
    font-size: 11px;
    font-weight: 500;
    letter-spacing: .06em;
    padding: 10px 12px;
    text-align: left;
    border-bottom: 1px solid var(--border);
    text-transform: uppercase;
    white-space: nowrap;
    position: sticky;
    top: 57px;
    background: var(--bg);
    z-index: 90;
  }
  th.sortable { cursor: pointer; user-select: none; }
  th.sortable:hover { color: var(--text); }
  th .sort-arrow { display: inline-block; width: 12px; opacity: .5; }
  th.sort-asc .sort-arrow::after  { content: " ↑"; }
  th.sort-desc .sort-arrow::after { content: " ↓"; }

  /* Column widths */
  th:nth-child(1), td:nth-child(1) { width: 46%; }
  th:nth-child(2), td:nth-child(2) { width: 14%; }
  th:nth-child(3), td:nth-child(3) { width: 10%; }
  th:nth-child(4), td:nth-child(4) { width: 10%; }
  th:nth-child(5), td:nth-child(5) { width: 10%; }
  th:nth-child(6), td:nth-child(6) { width: 10%; }

  tr { border-bottom: 1px solid var(--border); }
  tr:hover td { background: var(--surface); }

  td {
    padding: 9px 12px;
    color: var(--text);
    vertical-align: middle;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .title-cell a {
    color: var(--text);
    text-decoration: none;
    font-weight: 500;
  }
  .title-cell a:hover { color: var(--accent); }

  .source-badge {
    display: inline-block;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    padding: 2px 6px;
    text-transform: uppercase;
    letter-spacing: .04em;
  }
  .source-badge.kemono   { background: #1e2d3a; color: #5ba4cf; }
  .source-badge.eporner  { background: #2d1e2a; color: #cf5ba4; }
  .source-badge.fapello  { background: #1e2d1e; color: #5bcf5b; }
  .source-badge.bunkr    { background: #2d2a1e; color: #cfc25b; }
  .source-badge.erome    { background: #2a1e2d; color: #a45bcf; }

  .count-cell { color: var(--muted); }
  .count-cell strong { color: var(--text); }

  .video-badge {
    color: var(--accent);
    font-size: 11px;
    font-weight: 600;
  }

  .date-cell { color: var(--muted); font-size: 12px; }

  .link-cell a {
    color: var(--accent);
    font-size: 12px;
    text-decoration: none;
    opacity: .8;
  }
  .link-cell a:hover { opacity: 1; }

  /* ── Empty / loading ─────────────────────────────────────────────────────── */
  .empty {
    padding: 60px 24px;
    text-align: center;
    color: var(--muted);
  }

  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 80px 24px;
    color: var(--muted);
  }
  .spinner {
    width: 20px; height: 20px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin .7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ── Pagination ──────────────────────────────────────────────────────────── */
  .pagination {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 20px 24px 40px;
  }
  .page-btn {
    background: var(--tag-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    cursor: pointer;
    font-family: inherit;
    font-size: 13px;
    padding: 6px 14px;
    transition: all .15s;
  }
  .page-btn:hover { border-color: var(--accent); color: var(--accent); }
  .page-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; cursor: default; }
  .page-btn:disabled { opacity: .4; cursor: default; }
  .page-info { color: var(--muted); font-size: 12px; padding: 0 8px; }

  /* ── Mobile ──────────────────────────────────────────────────────────────── */
  @media (max-width: 640px) {
    header { padding: 12px 16px; }
    .filters, .table-wrap { padding-left: 16px; padding-right: 16px; }
    .header-stats { display: none; }
    th:nth-child(3), td:nth-child(3),
    th:nth-child(5), td:nth-child(5) { display: none; }
  }
</style>
</head>
<body>

<header>
  <a class="logo" href="/">Media<span>Index</span></a>
  <div class="search-wrap">
    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
    </svg>
    <input id="search" type="text" placeholder="Search by name, title, keywords…" autocomplete="off" spellcheck="false">
  </div>
  <div class="header-stats" id="stats"></div>
</header>

<div class="filters">
  <span class="filter-label">Source:</span>
  <button class="pill active" data-source="all">All</button>
  <button class="pill" data-source="kemono">Kemono</button>
  <button class="pill" data-source="eporner">Eporner</button>
  <button class="pill" data-source="fapello">Fapello</button>
  <button class="pill" data-source="bunkr">Bunkr</button>
  <button class="pill" data-source="erome">Erome</button>
  <span class="filter-label" style="margin-left:8px">Type:</span>
  <button class="pill active" data-type="all">All</button>
  <button class="pill" data-type="video">Videos</button>
  <button class="pill" data-type="photo">Photos</button>
  <select class="sort-select" id="sort">
    <option value="date_desc">Newest first</option>
    <option value="date_asc">Oldest first</option>
    <option value="count_desc">Most files</option>
    <option value="count_asc">Fewest files</option>
    <option value="title_asc">A → Z</option>
  </select>
</div>

<div class="table-wrap">
  <div class="loading" id="loading"><div class="spinner"></div> Loading index…</div>

  <table id="table" style="display:none">
    <thead>
      <tr>
        <th class="sortable" data-col="title">Title <span class="sort-arrow"></span></th>
        <th class="sortable" data-col="source">Source <span class="sort-arrow"></span></th>
        <th class="sortable" data-col="file_count">Files <span class="sort-arrow"></span></th>
        <th>Type</th>
        <th class="sortable" data-col="date">Date <span class="sort-arrow"></span></th>
        <th>Link</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="empty" id="empty" style="display:none">No results found.</div>
</div>

<div class="pagination" id="pagination"></div>

<script>
// ── State ────────────────────────────────────────────────────────────────────
const PAGE_SIZE  = 50;
let allAlbums    = [];
let filtered     = [];
let sortKey      = "date";
let sortDir      = "desc";
let currentPage  = 1;
let activeSource = "all";
let activeType   = "all";
let searchQ      = "";

// ── Helpers ──────────────────────────────────────────────────────────────────
function fmtDate(iso) {
  if (!iso) return "—";
  const d = new Date(iso);
  if (isNaN(d)) return "—";
  const now = Date.now();
  const diff = now - d;
  if (diff < 864e5)   return "Today";
  if (diff < 2*864e5) return "Yesterday";
  if (diff < 7*864e5) return Math.floor(diff/864e5) + "d ago";
  return d.toLocaleDateString("en-US", { year:"numeric", month:"short", day:"numeric" });
}

function fmtCount(n) {
  if (!n || n === 0) return "—";
  if (n >= 1000) return (n/1000).toFixed(1) + "k";
  return n.toString();
}

function escHtml(s) {
  return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

// ── Filter + sort ─────────────────────────────────────────────────────────────
function applyFilters() {
  const q = searchQ.toLowerCase().trim();

  filtered = allAlbums.filter(a => {
    if (activeSource !== "all" && a.source !== activeSource) return false;
    if (activeType === "video" && !a.has_videos) return false;
    if (activeType === "photo" && a.has_videos)  return false;
    if (q && !((a.title||"").toLowerCase().includes(q) ||
               (a.source||"").toLowerCase().includes(q) ||
               (a.service||"").toLowerCase().includes(q))) return false;
    return true;
  });

  // Sort
  filtered.sort((a, b) => {
    let va, vb;
    switch (sortKey) {
      case "title":      va = (a.title||"").toLowerCase(); vb = (b.title||"").toLowerCase(); break;
      case "source":     va = a.source||""; vb = b.source||""; break;
      case "file_count": va = a.file_count||0; vb = b.file_count||0; break;
      case "date":
      default:
        va = a.date || a.indexed_at || ""; vb = b.date || b.indexed_at || ""; break;
    }
    if (va < vb) return sortDir === "asc" ? -1 : 1;
    if (va > vb) return sortDir === "asc" ? 1 : -1;
    return 0;
  });

  currentPage = 1;
  render();
}

// ── Render ────────────────────────────────────────────────────────────────────
function render() {
  const table  = document.getElementById("table");
  const tbody  = document.getElementById("tbody");
  const empty  = document.getElementById("empty");
  const loading = document.getElementById("loading");

  loading.style.display = "none";

  if (filtered.length === 0) {
    table.style.display = "none";
    empty.style.display = "block";
    document.getElementById("pagination").innerHTML = "";
    return;
  }

  table.style.display = "";
  empty.style.display = "none";

  const totalPages = Math.ceil(filtered.length / PAGE_SIZE);
  const start = (currentPage - 1) * PAGE_SIZE;
  const page  = filtered.slice(start, start + PAGE_SIZE);

  tbody.innerHTML = page.map(a => {
    const src  = escHtml(a.source || "");
    const title = escHtml(a.title || a.id || "—");
    const url   = escHtml(a.url || "#");
    const count = fmtCount(a.file_count);
    const type  = a.has_videos ? '<span class="video-badge">▶ Video</span>' : '<span style="color:var(--muted);font-size:12px">Photo</span>';
    const date  = fmtDate(a.date || a.indexed_at);

    // Short link label
    let linkLabel = "Visit";
    try { linkLabel = new URL(a.url).hostname.replace("www.", ""); } catch(e) {}

    return `<tr>
      <td class="title-cell"><a href="${url}" target="_blank" rel="noopener">${title}</a></td>
      <td><span class="source-badge ${src}">${src}</span></td>
      <td class="count-cell"><strong>${count}</strong></td>
      <td>${type}</td>
      <td class="date-cell">${date}</td>
      <td class="link-cell"><a href="${url}" target="_blank" rel="noopener">↗ ${escHtml(linkLabel)}</a></td>
    </tr>`;
  }).join("");

  renderPagination(totalPages);
}

function renderPagination(totalPages) {
  const el = document.getElementById("pagination");
  if (totalPages <= 1) { el.innerHTML = ""; return; }

  let html = "";
  html += `<button class="page-btn" ${currentPage===1?"disabled":""} onclick="goPage(${currentPage-1})">← Prev</button>`;
  html += `<span class="page-info">Page ${currentPage} of ${totalPages}</span>`;
  html += `<button class="page-btn" ${currentPage===totalPages?"disabled":""} onclick="goPage(${currentPage+1})">Next →</button>`;
  el.innerHTML = html;
}

function goPage(p) {
  currentPage = p;
  render();
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function updateStats() {
  const total = allAlbums.length;
  const srcs  = [...new Set(allAlbums.map(a => a.source))];
  document.getElementById("stats").textContent =
    `${total.toLocaleString()} records · ${srcs.join(", ")}`;
}

// ── Header sorting ────────────────────────────────────────────────────────────
document.querySelectorAll("th.sortable").forEach(th => {
  th.addEventListener("click", () => {
    const col = th.dataset.col;
    if (sortKey === col) {
      sortDir = sortDir === "asc" ? "desc" : "asc";
    } else {
      sortKey = col;
      sortDir = col === "title" ? "asc" : "desc";
    }
    // Update arrow classes
    document.querySelectorAll("th.sortable").forEach(t => {
      t.classList.remove("sort-asc","sort-desc");
    });
    th.classList.add(sortDir === "asc" ? "sort-asc" : "sort-desc");
    applyFilters();
  });
});

// ── Source filters ────────────────────────────────────────────────────────────
document.querySelectorAll(".pill[data-source]").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".pill[data-source]").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    activeSource = btn.dataset.source;
    applyFilters();
  });
});

// ── Type filters ──────────────────────────────────────────────────────────────
document.querySelectorAll(".pill[data-type]").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".pill[data-type]").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    activeType = btn.dataset.type;
    applyFilters();
  });
});

// ── Sort dropdown ─────────────────────────────────────────────────────────────
document.getElementById("sort").addEventListener("change", e => {
  const [key, dir] = e.target.value.split("_");
  sortKey = key;
  sortDir = dir;
  applyFilters();
});

// ── Search ────────────────────────────────────────────────────────────────────
let searchTimer;
document.getElementById("search").addEventListener("input", e => {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => {
    searchQ = e.target.value;
    applyFilters();
  }, 200);
});

// ── Load data ─────────────────────────────────────────────────────────────────
fetch("albums.json")
  .then(r => r.json())
  .then(data => {
    allAlbums = data.albums || [];
    updateStats();
    // Default sort by date desc
    sortKey = "date"; sortDir = "desc";
    document.querySelector("th[data-col='date']").classList.add("sort-desc");
    applyFilters();
  })
  .catch(err => {
    document.getElementById("loading").innerHTML =
      '<span style="color:#f87">Failed to load index. Try refreshing.</span>';
    console.error(err);
  });
</script>
</body>
</html>
